<script>
    var EnquiryId_Global = 0;
    var UserToken_Global = "";
    var _FollowUpTable;

    function initializeDataTable_FollowUp() {
        _FollowUpTable = $("#tblFollowUp").DataTable();
    }

    $(document).ready(function () {
        $.get("/Business/GetBusinessAdminToken", null, function (dataToken) {
            if (dataToken != "" && dataToken != null) {
                UserToken_Global = dataToken;
                initializeDataTable_FollowUp();
                GetAllBusinessFollowUp();


                StopLoading();
            }
            else {
                $.get("/Staff/GetStaffToken", null, function (dataToken) {
                    if (dataToken != "" && dataToken != null) {
                        UserToken_Global = dataToken;
                        initializeDataTable_FollowUp();
                        GetAllBusinessFollowUp();


                        StopLoading();
                    }
                    else {
                        StopLoading();
                    }
                });
            }
        });
    });

    function ResetTextView()
    {
        EnquiryId_Global = 0;
        $('#text_Comment').val('');
        $(".error-class").html('');
    }

    function GetAllBusinessFollowUp() {
    // ---------------- Pagination Data Table --------------------
        var _url_val = "/api/FollowUp/GetAllByPagination";
    _FollowUpTable.clear().destroy();
    _FollowUpTable = $("#tblFollowUp").DataTable({
        "processing": true,
        "serverSide": true,
        "filter": true,
        "orderMulti": false,
        "ordering": true,
        "paginate": true,
        "order": [[4, "desc"]],
        "ajax": {
            "headers": {
                "Authorization": "Bearer " + UserToken_Global
            },
            "url": _url_val,
            "type": "POST",
            "error": function (result) {
                if (result["status"] == 401) {
                    $.iaoAlert({
                        msg: '@(Resources.ErrorMessage.UnAuthorizedErrorMessage)',
                        type: "error",
                        mode: "dark",
                    });
                }
                else {
                    $.iaoAlert({
                        msg: '@(Resources.ErrorMessage.TechincalErrorMessage)',
                        type: "error",
                        mode: "dark",
                    });
                }
            }
        },
        "columns": [
            { "data": "SerialNumber", "name": "SerialNumber", "autoWidth": true }
            , { "data": "BusinessName", "name": "BusinessName", "autoWidth": true }
            , { "data": "StaffName", "name": "StaffName", "autoWidth": true }
            , {
                "data": "StartFromDate", "name": "StartFromDate", "autoWidth": true
                , "render": function (data, type, row) {
                    return `<span style="display:none;">${moment(row.StartFromDate_DateTimeFormat).format('YYYY-MM-DD')}</span> ${row.StartFromDate_DateTimeFormat}`;
                }
            }
            , {
                "data": "FollowUpDate", "name": "FollowUpDate", "autoWidth": true,
                "render": function (data, type, row) {
                    return `<span style="display:none;">${moment(row.FollowUpDate_DateTimeFormat).format('YYYY-MM-DD')}</span> ${row.FollowUpDate_DateTimeFormat}`;
                }
            }
            , {
                "data": null, "": "EnquiryStatus", "autoWidth": true
                , "render": function (data, type, row) {
                    //---Check Rating-Status
                    var _status = '';
                    if (row.EnquiryStatus == 0) {
                        _status = '<span class="badge badge-warning  text-white px-1 py-1" style="width:max-content;">Pending</span>';
                    }
                    else if (row.EnquiryStatus == 1) {
                        _status = '<span class="badge badge-success text-white px-1 py-1" style="width:max-content;">Open</span>';
                    }
                    else if (row.EnquiryStatus == 2) {
                        _status = '<span class="badge badge-danger text-white px-1 py-1" style="width:max-content;">Close</span>';
                    }

                    return _status;
                }
            }
            , {
                "data": null, "": "Action", "autoWidth": true,
                "render": function (data, type, row) {
                    var _follow = '<button class="btn btn-sm btn-info text-white" style="width:max-content;" onclick="ViewEnquiryCommentDetail(' + row.Id + ');">Follow</button>';
                   
                    var _action = `<div class="edbt">
                                ${_follow}
                            </div>`;
                    return _action;
                }
            }
        ],
        "responsive": true,
        "autoWidth": false,
        "columnDefs": [{
            "targets": [0, 6], // column index (start from 0)
            "orderable": false, // set orderable false for selected columns
        }]
    });

    // for enabling search box only send requet on pressing enter
    $('#tblFollowUp_filter input').unbind();
    $('#tblFollowUp_filter input').bind('keyup', function (e) {
        if (e.keyCode == 13 || (e.keyCode == 8 && $(this).val() == '')) {
            _FollowUpTable.search(this.value).draw();
        }
    });

    // ----------------  Pagination Data Table ------------------
    }


    $('#enquiryfollowsupDetailModal').on('hide.bs.modal', function () {
        ResetViewBusinessEnquiryCommentDetailModal();
    });


    function ResetViewBusinessEnquiryCommentDetailModal() {
        EnquiryId_Global = 0;
        $('#EditBusinessEnquiryfollowsupModal').html('');
    }

    function ViewEnquiryCommentDetail(Id) {
        EnquiryId_Global = Id;
        $('#EditBusinessEnquiryfollowsupModal').html('');
        getBusinessEnquiryCommentDetail(callbackBusinessEnquiryCommentDetailDataModal);
    }

    function callbackBusinessEnquiryCommentDetailDataModal(apiResponse) {
        EnquiryId_Global = apiResponse.data.EnquiryDetail.Id;
       
        var _htmlData = ``;
        var _htmlData1 = ``;
        _htmlData += `<div class="row" ><div class="col-md-4"><span><b>Name :</b></span>&nbsp${apiResponse.data.EnquiryDetail.Name}</div><div class="col-md-4"><span><b>Email :</b></span>&nbsp${apiResponse.data.EnquiryDetail.Email}</div><div class="col-md-4"><span><b>Address :</b></span>&nbsp${apiResponse.data.EnquiryDetail.Address}</div></div ></br > <div class="row"><div class="col-md-4"><span><b>Gender :</b></span>&nbsp${apiResponse.data.EnquiryDetail.Gender}</div><div class="col-md-4"><span><b>PhoneNumber :</b></span>&nbsp${apiResponse.data.EnquiryDetail.PhoneNumber}</div><div class="col-md-4"><span><b>Activity :</b></span>&nbsp${apiResponse.data.EnquiryDetail.Activity}</div></div></br > <div class="row"><div class="col-md-4"><span><b>Alternate Number :</b></span>&nbsp${apiResponse.data.EnquiryDetail.AlternatePhoneNumber}</div><div class="col-md-4"><span><b>Start Date :</b></span>&nbsp${apiResponse.data.EnquiryDetail.StartFromDate}</div><div class="col-md-4"><span><b>Notes :</b></span>&nbsp${apiResponse.data.EnquiryDetail.Notes}</div></div></div ></br ></div>`;

        for (var i = 0; i < apiResponse.data.EnquiryComments.length; i++) {
            _htmlData1 += `<div class="p-2 previousComments mb-3">`;
            _htmlData1 += `<div><strong>Followed On:</strong> ${apiResponse.data.EnquiryComments[i].CreatedOn_FormatDate}</div><div> ${apiResponse.data.EnquiryComments[i].Comments}</div>`;
            _htmlData1 += `</div>`; 
            $("#CommentsList").html(_htmlData1);
        }

        if (apiResponse.data.EnquiryComments.length <= 0) {
            $("#CommentsList").html(`<div class="w-100 font-italic text-center text-black-50 py-2">No Comments in this Enquiry.</div>`);
        }

        _htmlData += `</div>`;
        $('#EditBusinessEnquiryfollowsupModal').html(_htmlData);
       
        $('#enquiryfollowsupDetailModal').modal('show');
    }

    function getBusinessEnquiryCommentDetail(callbackFunction) {

        let _url = "/api/FollowUp/EnquiryDetailGetById?id=" + EnquiryId_Global;
        StartLoading();

        //showSpinnerInAddMemberModal();
        //$('#addGroupMemberModal').modal('show');
        $.ajax({
            type: "GET",
            url: _url,
            headers: {
                "Authorization": "Bearer " + UserToken_Global,
                "Content-Type": "application/json"
            },
            contentType: 'application/json',
            success: function (response) {
                if (response.status < 1) {
                    $.iaoAlert({
                        msg: response.message,
                        type: "error",
                        mode: "dark",
                    });
                    return;
                }


               // $("#ddlSelectedStatus").val(response.data[i].ReviewBody);
                EnquiryId_Global = response.data.EnquiryDetail.Id;

                callbackFunction(response);

                StopLoading();
            },
            error: function (result) {
                StopLoading();

                if (result["status"] == 401) {
                    $.iaoAlert({
                        msg: '@Resources.ErrorMessage.UnAuthorizedErrorMessage',
                        type: "error",
                        mode: "dark",
                    });
                }
                else {
                    $.iaoAlert({
                        msg: '@Resources.ErrorMessage.TechincalErrorMessage',
                        type: "error",
                        mode: "dark",
                    });
                }
            }
        });
    }

    function btnSubmitFormCommentClick() {

    let is_valid = true;
  //  $("#sectionAddUpdateEnquiry .error-class").html('');


        var _comments = $('#text_Comment').val();
   
        var _error_comments = $('#error_text_Comment');
       


        if (validate_IsEmptyStringInputFieldValue(_comments)) {
        is_valid = false;
            _error_comments.html('@(Resources.BusinessPanel.Enquiry_FollowUpCommentRequired)');
    }



    if (is_valid) {

        var _mode = 1 ;

        var data = new FormData();
        data.append("Id", EnquiryId_Global);
        data.append("Comments", _comments);
        data.append("Mode", _mode);

        $.ajax({
            url: '/api/FollowUp/UpdateEnquiryfollowsupDetail?id=' + EnquiryId_Global,
            headers: {
                "Authorization": "Bearer " + UserToken_Global
            },
            data: data,
            processData: false,
            mimeType: 'multipart/form-data',
            contentType: false,
            //contentType: 'application/json',
            type: 'POST',
            success: function (dataResponse) {
                StopLoading();

                //--Parse into Json of response-json-string
                dataResponse = JSON.parse(dataResponse);

                //--If successfully added/updated
                if (dataResponse.status === 1) {
                    swal("Success!", dataResponse.message, "success");
                    getBusinessEnquiryCommentDetail(callbackBusinessEnquiryCommentDetailDataModal);
                    ResetTextView();
                }
                else {
                    swal({
                        title: 'Error!',
                        icon: 'error',
                        text: dataResponse.message
                    });
                }

            },
            error: function (result) {
                StopLoading();

                if (result["status"] == 401) {
                    $.iaoAlert({
                        msg: '@(Resources.ErrorMessage.UnAuthorizedErrorMessage)',
                        type: "error",
                        mode: "dark",
                    });
                }
                else {
                    $.iaoAlert({
                        msg: '@(Resources.ErrorMessage.UnAuthorizedErrorMessage)',
                        type: "error",
                        mode: "dark", 
                    });
                }
            }
        });
    }

}
    ////// -----------    FIELD VALIDATION HANDLER FUNCTIONS  --------------------------

    const validate_IsEmptyStringInputFieldValue = function (inputFieldValue) {
        if (inputFieldValue == '' || inputFieldValue.replace(/\s/g, "") == "")
            return true;
        return false;
    }

    const validate_IsEmptySelectInputFieldValue = function (inputFieldValue) {
        if (inputFieldValue == undefined || inputFieldValue == null || inputFieldValue == '' || inputFieldValue == 0)
            return true;
        return false;
    }
    ////// -----------    FIELD VALIDATION HANDLER FUNCTIONS  --------------------------

</script>
