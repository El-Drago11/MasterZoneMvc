@using MasterZoneMvc.ViewModels;

@{
    var UserRole = Context.Items["UserRole"] as string;

    string ControllerNameForLinks = (UserRole == "BusinessAdmin") ? "Business" : "Staff";
    var Permissions = Context.Items["Permissions"] as List<PermissionHierarchy_VM>;
    List<PermissionHierarchy_VM> permissions = Permissions;
    List<string> permissionKeys = new List<string>();
    if (permissions.Count() > 0)
    {
        permissionKeys = permissions.Select(p => p.KeyName).ToList();
    }
}

<script>
    var UserToken_Global = "";
    var BusinessServiceId_Global = 0;


    function initializeDataTable_BusinessService() {
        _businessserviceTable = $("#ViewForBusinessService").DataTable();
    }

    $(document).ready(function () {
        $.get("/Business/GetBusinessAdminToken", null, function (dataToken) {
            if (dataToken != "" && dataToken != null) {
                UserToken_Global = dataToken;

                initializeDataTable_BusinessService();

                GetAllBusinessService();
                StopLoading();
            }
            else {
                $.get("/Business/GetStaffToken", null, function (dataToken) {
                    if (dataToken != "" && dataToken != null) {
                        UserToken_Global = dataToken;
                        getAllInstructorLists();
                        initializeDataTable_BusinessService();

                        GetAllBusinessService();
                        //StopLoading();
                    }
                    else {
                        StopLoading();
                    }
                });
            }
        });
    });


    function GetAllBusinessService() {

        // ---------------- Pagination Data Table --------------------
        var _url_val = "/api/Business/GetAllBusinessServiceByPagination";
        _businessserviceTable.clear().destroy();
        _businessserviceTable = $("#ViewForBusinessService").DataTable({
            "processing": true,
            "serverSide": true,
            "filter": true,
            "orderMulti": false,
            "ordering": true,
            "paginate": true,
            "order": [[3, "desc"]],
            "ajax": {
                "headers": {
                    "Authorization": "Bearer " + UserToken_Global
                },
                "url": _url_val,
                "type": "POST",
                //"data": { "_Params": JSON.stringify(_Params) },
                //"datatype": "json",
                "error": function (result) {
                    if (result["status"] == 401) {
                        $.iaoAlert({
                            msg: '@Resources.ErrorMessage.UnAuthorizedErrorMessage',
                            type: "error",
                            mode: "dark",
                        });
                    }
                    else {
                        $.iaoAlert({
                            msg: '@Resources.ErrorMessage.TechincalErrorMessage',
                            type: "error",
                            mode: "dark",
                        });
                    }
                }
            },
            "columns": [
                {
                    "data": "SerialNumber", "name": "CreatedOn", "autoWidth": true
                    //,"render": function (data, type, row) {
                    //    return '';
                    //}
                }
                , { "data": "Title", "name": "Title", "autoWidth": true }
                , {
                    "data": "Description",
                    "name": "Description",
                    "autoWidth": true,
                    "render": function (data, type, row) {
                        var maxLength = 150; // Maximum length to show initially
                        var description = data;
                        var readMoreHtml = '<a href="#" class="read-more">Read more</a>';
                        var showLessHtml = '<a href="#" class="read-less">Show less</a>';
                        if (description.length > maxLength) {
                            var trimmedDescription = description.substr(0, maxLength);

                        }
                        if (description.length < maxLength) {
                            return '<span class="description"><span class="full-description">' + description + '.';

                        } else {

                            return '<span class="description"><span class="full-description d-none">' + description + '...' + showLessHtml + '</span ><span class="truncated-description">' + trimmedDescription + '...' + readMoreHtml + '</span></span> ';
                        }
                    }
                }
                , {
                    "data": "Icon", "name": "Icon", "autoWidth": true
                    , "render": function (data, type, row) {
                        return `<img src="${row.BusinessServiceIconWithPath}" class="image" />`
                    }
                }


                , {
                    "data": null, "": "action", "autowidth": true,
                    "render": function (data, type, row) {

                        var _edit = '';
                        var _delete = '';


                        _edit = `<a href="javascript:EditBusinessServiceDetail(${row.Id});"><i class="fas fa-edit" title="Edit"></i></a>`;



                        _delete = `<a href="javascript:ConfirmDeletedBusinessService(${row.Id});"><i class="fas fa-trash" title="Delete"></i></a>`;


                        var _action = `<div class="edbt">


                                    ${_edit}
                                    ${_delete}
                                </div>`;
                        return _action;
                    }
                }


            ],

            "responsive": true,
            "autoWidth": false,
            //"dom": "<'row my-3'<'col-sm-12'B>><'row'<'col-sm-6'l><'col-sm-6'f>><'row'<'col-sm-12'tr>><'row'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>",
            "columnDefs": [{
                "targets": [0,4], // column index (start from 0)
                "orderable": false, // set orderable false for selected columns
            }]
        });
        // for read more show less functionality of description
        $(document).on('click', '.read-more', function (e) {
            e.preventDefault();
            $(this).closest('.description').find('.full-description').removeClass('d-none');
            $(this).closest('.description').find('.truncated-description').addClass('d-none');
        });
        $(document).on('click', '.read-less', function (e) {
            e.preventDefault();
            $(this).closest('.description').find('.full-description').addClass('d-none');
            $(this).closest('.description').find('.truncated-description').removeClass('d-none');
        });
        // for enabling search box only send requet on pressing enter
        $('#ViewForBusinessService_filter input').unbind();
        $('#ViewForBusinessService_filter input').bind('keyup', function (e) {
            if (e.keyCode == 13 || (e.keyCode == 8 && $(this).val() == '')) {
                _businessserviceTable.search(this.value).draw();
            }
        });

        // ----------------  Pagination Data Table ------------------
    }

    $('#btnBusinessServiceAdd').click(function () {
        $("#BusinessServiceStatusInserted").addClass('d-none');
        $('#sectionAddBusinessService').show();
        $('#sectionViewBusinessService').hide();
        $('#btnBusinessServiceAdd').hide();
        document.getElementById("pageTextchange").innerHTML = "Add Business Services";
        document.getElementById("pageStageChange").innerHTML = "Add Business Services";

    });

    function ResetAddView() {
        $('#btnBusinessServiceAdd').show();
        $('#sectionAddBusinessService').hide();
        $('#sectionViewBusinessService').show();
        $('#ddlBusinessService_ManageBusinessService').val('0');
        $('#Title_Name').val('');
        $('#Service_Type').val('');
        $('#businessservice_description').val('');
        $(".error-class").html('');
        $("#fileBusinessServiceImage").val('');
        $("#fileBusinessserviceIcon").val('');
        $("#previewImage").attr('src', '');
        $("#previewImage").addClass('d-none');
        $("#previewIcon").attr('src', '');
        $("#previewIcon").addClass('d-none');
        BusinessServiceId_Global = 0;
          document.getElementById("pageTextchange").innerHTML = "View Business Services";
        document.getElementById("pageStageChange").innerHTML = "View Business Services";
    }


    function btnSubmitToBusinessServiceInfo() {
        
        let is_valid = true;
        $(".error-class").html('');
        var _mode = (BusinessServiceId_Global > 0) ? 2 : 1;

        let _businessservicetitle = $("#Title_Name").val().trim();
        let _businessservicetype = $("#Service_Type").val();
        let _businessservicedescription = $("#businessservice_description").val().trim();
       let _businessservicestatus = $("#ddlBusinessService_ManageBusinessService").val().trim();

        let _error_businessservicetitle = $("#error_Title_Name");
        let _error_businessservicetype = $("#error_Service_Type");
        let _error_businessservicedescription = $("#error_businessservice_description");
        let _error_businessservicestatus = $("#error_ddlBusinessService_ManageBusinessService");
        let _error_businessServiceImage = $("#error_fileBusinessServiceImage");
        let _error_businessfeatureIcon = $("#error_fileBusinessserviceIcon");

        if (validate_IsEmptyStringInputFieldValue(_businessservicetitle)) {
                is_valid = false;
            _error_businessservicetitle.html('@(Resources.BusinessPanel.BusinessServiceTitleRequired)');

        }

        if (validate_IsEmptyStringInputFieldValue(_businessservicetype)) {
                is_valid = false;
            _error_businessservicetype.html('@(Resources.BusinessPanel.BusinessServiceTitleRequired)');

        }

        if (validate_IsEmptyStringInputFieldValue(_businessservicedescription)) {
            is_valid = false;
            _error_businessservicedescription.html('@(Resources.BusinessPanel.BusinessServiceShortDescriptionRequired)');
        }
        var _businessServiceImageFile_MS = $("#fileBusinessServiceImage").get(0);
        var _businessServiceImageFiles = _businessServiceImageFile_MS.files;



             if (_mode == 1 && _businessServiceImageFiles.length <= 0) {
                 _error_businessServiceImage.html('@(Resources.BusinessPanel.BusinessServiceImageRequired)');
            return;
        }

        if (_mode == 2) {
            if (_businessservicestatus <= 0) {
                is_valid = false;
                _error_businessservicestatus.html('@(Resources.BusinessPanel.BusinessServiceStatusRequired)');
            }
        }
        var _businessServiceIconFile_MS = $("#fileBusinessserviceIcon").get(0);
        var _businessServiceIconFiles = _businessServiceIconFile_MS.files;


             if (_mode == 1 && _businessServiceIconFiles.length <= 0) {
                 _error_businessfeatureIcon.html('@(Resources.BusinessPanel.BusinessServiceIconRequired)');
            return;
        }


         if (is_valid) {
             var data = new FormData();

             data.append("Id", BusinessServiceId_Global);
             data.append("Title", _businessservicetitle);
             data.append("Description", _businessservicedescription);
             data.append("Status", _businessservicestatus);
             data.append("ServiceType", _businessservicetype);
            data.append('Mode', _mode);


             data.append('FeaturedImage', _businessServiceImageFiles[0]);


             data.append('Icon', _businessServiceIconFiles[0]);

            $.ajax({
                url: '/api/Business/AddUpdateBusinessServiceInformation',
                headers: {
                    "Authorization": "Bearer " + UserToken_Global,

                },
                data: data,
                processData: false,
                mimeType: 'multipart/form-data',
                contentType: false,
                //contentType: 'application/json',
                type: 'POST',
                success: function (dataResponse) {

                    //--Parse into Json of response-json-string
                    dataResponse = JSON.parse(dataResponse);

                    //--If successfully added/updated
                    if (dataResponse.status === 1) {
                        swal("Success!", dataResponse.message, "success");
                        ResetAddView();
                        GetAllBusinessService();
                    }
                    else {
                        swal({
                            title: 'Error!',
                            icon: 'error',
                            text: dataResponse.message
                        });
                        StopLoading();

                        return;
                    }


                    StopLoading();

                },
                error: function (result) {
                    //StopLoading();


                    if (result["status"] == 401) {
                        $.iaoAlert({
                            msg: '@(Resources.ErrorMessage.UnAuthorizedErrorMessage)',
                            type: "error",
                            mode: "dark",
                        });
                    }
                    else {
                        $.iaoAlert({
                            msg: '@(Resources.ErrorMessage.TechincalErrorMessage)',
                            type: "error",
                            mode: "dark",
                        });
                    }
                }
            });
        }

    }

    function EditBusinessServiceDetail(Id) {

        $("#BusinessServiceStatusInserted").removeClass('d-none');
        $('#sectionAddBusinessService').show();
        $('#sectionViewBusinessService').hide();
        document.getElementById("myText").innerHTML = "Edit ";
        document.getElementById("ChangeUpdateText").innerHTML = "Update";
         document.getElementById("pageTextchange").innerHTML = "Edit Business Servies";
         document.getElementById("pageStageChange").innerHTML = "Edit Business Services";
        $('#ChangeUpdateText').show();
        $('#btnBusinessServiceAdd').hide();
        $(".error-class").html('');
        $('#btnBusinessServiceAdd').click(function () {
             document.getElementById("myText").innerHTML = "Add Businesss Services";
            document.getElementById("ChangeUpdateText").innerHTML = "Save";
            $(".error-class").html('');
         });

        var _url = "/api/Business/GetBusinessServiceDetail?id=" + Id;

        StartLoading();

        $.ajax({
            type: "GET",
            url: _url,
            headers: {
                "Authorization": "Bearer " + UserToken_Global,
                "Content-Type": "application/json"
            },
            contentType: 'application/json',
            success: function (response) {
                if (response.status < 1) {
                    $.iaoAlert({
                        msg: response.message,
                        type: "error",
                        mode: "dark",
                    });
                    return;
                   /* getAllActiveStudentsLists();*/
                }
                
                BusinessServiceId_Global = response.data.Id;
                $("#Title_Name").val(response.data.Title);
                $("#businessservice_description").val(response.data.Description);
                $("#Service_Type").val(response.data.ServiceType);



                $("#fileBusinessServiceImage").val('');
                if (response.data.BusinessServiceImageWithPath != "") {
                    $("#previewImage").attr('src', response.data.BusinessServiceImageWithPath);
                    $("#previewImage").removeClass('d-none');
                }
                $("#fileBusinessserviceIcon").val('');
                if (response.data.BusinessServiceIconWithPath != "") {
                    $("#previewIcon").attr('src', response.data.BusinessServiceIconWithPath);
                    $("#previewIcon").removeClass('d-none');
                }

                StopLoading();
            },
            error: function (result) {
                StopLoading();

                if (result["status"] == 401) {
                    $.iaoAlert({
                        msg: '@(Resources.ErrorMessage.UnAuthorizedErrorMessage)',
                        type: "error",
                        mode: "dark",
                    });
                }
                else {
                    $.iaoAlert({
                        msg: '@(Resources.ErrorMessage.TechincalErrorMessage)',
                        type: "error",
                        mode: "dark",
                    });
                }
            }
        });
    };

    function ConfirmDeletedBusinessService(id) {

        swal({
            title: "@(Resources.BusinessPanel.ConfirmDeletedBusinessServiceTitleMessage)",
            text: "@(Resources.BusinessPanel.ConfirmDeletedBusinessServiceTextMessage)",
            type: "warning",
            buttons: {
                cancel: true,
                confirm: "@(Resources.ErrorMessage.Yes)",
            }
        })
        .then((willDelete) => {
            if (willDelete) {
                DeletedBusinessService(id);
            } else {
                //swal("Your imaginary file is safe!");
            }
        });
    }

    function DeletedBusinessService(id) {
        StartLoading();
        $.ajax({
            type: "POST",
            url: "/api/Business/BusinessServiceDelete?id=" + id,
            headers: {
                "Authorization": "Bearer " + UserToken_Global,
                "Content-Type": "application/json"
            },
            contentType: 'application/json',
            success: function (dataResponse) {
                StopLoading();

                //--Check if business service successfully deleted
                if (dataResponse.status == 1) {
                    setTimeout(function () {
                        swal("Success!", dataResponse.message, "success");
                        GetAllBusinessService();
                    }, 100);
                }
                else {
                    $.iaoAlert({
                        msg: '@(Resources.ErrorMessage.TechincalErrorMessage)',
                        type: "error",
                        mode: "dark",
                    });
                }
            },
            error: function (result) {
                StopLoading();

                if (result["status"] == 401) {
                    $.iaoAlert({
                        msg: '@(Resources.ErrorMessage.UnAuthorizedErrorMessage)',
                        type: "error",
                        mode: "dark",
                    });
                }
                else {
                    $.iaoAlert({
                        msg: '@(Resources.ErrorMessage.TechincalErrorMessage)',
                        type: "error",
                        mode: "dark",
                    });
                }
            }
        });
    }




    ////// -----------    FIELD VALIDATION HANDLER FUNCTIONS  --------------------------

    const validate_IsEmptyStringInputFieldValue = function (inputFieldValue) {
        if (inputFieldValue == '' || inputFieldValue.replace(/\s/g, "") == "")
            return true;
        return false;
    }

    const validate_IsEmptySelectInputFieldValue = function (inputFieldValue) {
        if (inputFieldValue == undefined || inputFieldValue == null || inputFieldValue == '' || inputFieldValue == 0)
            return true;
        return false;
    }
    ////// -----------    FIELD VALIDATION HANDLER FUNCTIONS  --------------------------


// Image File Preview -------------------------------------------------------------
    document.getElementById('fileBusinessServiceImage').addEventListener('change', handleImageUpload);

function handleImageUpload(event) {
    const file = event.target.files[0];
    const fileSize = file.size / 1024; // size in kilobytes
    const maxSize = 10*1024*1024; // maximum size in kilobytes
    const fileType = file.type;
    const validImageTypes = ['image/jpeg', 'image/png'];

    if (!validImageTypes.includes(fileType)) {
        $.iaoAlert({
            msg: '@(Resources.BusinessPanel.ValidImageTypesRequired)',
            type: "error",
            mode: "dark",
        });
        event.target.value = null; // clear the file input element
        $('#previewImage').addClass('d-none'); // hide the preview image
        return;
    }
    if (fileSize > maxSize) {
        $.iaoAlert({
            msg: '@(String.Format(Resources.BusinessPanel.FileSizeRequired, "10 MB"))',
            type: "error",
            mode: "dark",
        });
        event.target.value = null; // clear the file input element
        $('#previewImage').addClass('d-none'); // hide the preview image

        return;
    }

    // image size is within the limit, display the preview image
    const reader = new FileReader();
    reader.onload = function (event) {
        document.getElementById('previewImage').src = event.target.result;
        $('#previewImage').removeClass('d-none');
    }

    reader.readAsDataURL(file);
}
// Image File Preview -------------------------------------------------------------
    document.getElementById('fileBusinessserviceIcon').addEventListener('change', handleIconUpload);

    function handleIconUpload(event) {
    const file = event.target.files[0];
    const fileSize = file.size / 1024; // size in kilobytes
    const maxSize = 10*1024*1024; // maximum size in kilobytes
    const fileType = file.type;
    const validImageTypes = ['image/jpeg', 'image/png'];

    if (!validImageTypes.includes(fileType)) {
        $.iaoAlert({
            msg: '@(Resources.BusinessPanel.ValidImageTypesRequired)',
            type: "error",
            mode: "dark",
        });
        event.target.value = null; // clear the file input element
        $('#previewIcon').addClass('d-none'); // hide the preview image
        return;
    }
    if (fileSize > maxSize) {
        $.iaoAlert({
            msg: '@(String.Format(Resources.BusinessPanel.FileSizeRequired, "10 MB"))',
            type: "error",
            mode: "dark",
        });
        event.target.value = null; // clear the file input element
        $('#previewIcon').addClass('d-none'); // hide the preview image

        return;
    }

    // image size is within the limit, display the preview image
    const reader = new FileReader();
    reader.onload = function (event) {
        document.getElementById('previewIcon').src = event.target.result;
        $('#previewIcon').removeClass('d-none');
    }

    reader.readAsDataURL(file);
}


</script>

