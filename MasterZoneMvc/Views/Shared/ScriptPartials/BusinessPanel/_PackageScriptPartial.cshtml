@using MasterZoneMvc.ViewModels;

@{
    var UserRole = Context.Items["UserRole"] as string;

    string ControllerNameForLinks = (UserRole == "BusinessAdmin") ? "Business" : "Staff";
    var Permissions = Context.Items["Permissions"] as List<PermissionHierarchy_VM>;
    List<PermissionHierarchy_VM> permissions = Permissions;
    List<string> permissionKeys = new List<string>();
    if (permissions.Count() > 0)
    {
        permissionKeys = permissions.Select(p => p.KeyName).ToList();
    }
}

<script>
var PlanId_Global = 0;
var UserToken_Global = "";
var DiscountPercent_Global = 0;

$(document).ready(function () {
    $.get("/Business/GetBusinessAdminToken", null, function (dataToken) {
        if (dataToken != "" && dataToken != null) {
            UserToken_Global = dataToken;
            GetAllBusinessPlans();
            //StopLoading();
        }
        else {
            $.get("/Staff/GetStaffToken", null, function (dataToken) {
                if (dataToken != "" && dataToken != null) {
                    UserToken_Global = dataToken;
                    GetAllBusinessPlans();
                    //StopLoading();
                }
                else {
                    StopLoading();
                }
            });
        }
    });

    $('#btnAddPackage').click(function () {
        $('#sectionAddStaff').show();
        $('#btnAddPackage').hide();
        $('#sectionViewStaff').hide();
        document.getElementById("pageTextchange").innerHTML = "Add Package";
        document.getElementById("pageStageChange").innerHTML = "Add Package";
    });
});

function GetAllBusinessPlans() {
    var _url = "/api/BusinessPlan/GetAll";

    $.ajax({
        type: "GET",
        url: _url,
        headers: {
            "Authorization": "Bearer " + UserToken_Global,
            "Content-Type": "application/json"
        },
        contentType: 'application/json',
        success: function (response) {
            if (response.status < 1) {
                $.iaoAlert({
                    msg: response.message,
                    type: "error",
                    mode: "dark",
                });
                return;
            }

            $('#BusinessPlanCardList').html('');
            var cardsData = "";
            for (var i = 0; i < response.data.length; i++) {
                cardsData += bindPlanDataToCard(response.data[i]);
            }

            if (response.data.length <= 0) {
                cardsData += `<div class="w-100 text-center"><i> No Plan/Packages </i><div>`;
            }

            $('#BusinessPlanCardList').append(cardsData);

            StopLoading();
            GetAllBusinessPlanDurationTypes();
        },
        error: function (result) {
            StopLoading();
            GetAllBusinessPlanDurationTypes();

            if (result["status"] == 401) {
                $.iaoAlert({
                    msg: '@(Resources.ErrorMessage.UnAuthorizedErrorMessage)',
                    type: "error",
                    mode: "dark",
                });
            }
            else {
                $.iaoAlert({
                    msg: '@(Resources.ErrorMessage.TechincalErrorMessage)',
                    type: "error",
                    mode: "dark",
                });
            }
        }
    });
}

    function bindPlanDataToCard(businessPlan) {
        var compareAtPriceHTML = (businessPlan.CompareAtPrice <= 0) ? '' : `<p class="h5 mb-2 text-danger"><strike>Rs. ${businessPlan.CompareAtPrice}</strike></p>`;
        var _image = (businessPlan.PlanImageWithPath == "") ? '' : `<img src="${businessPlan.PlanImageWithPath}" class="image mb-2">`;
        var _discountBubble = (businessPlan.DiscountPercent <= 0) ? '' : `<div class="plan-discount-bubble">${businessPlan.DiscountPercent}% off</div>`;
    var cardData = `
        <div class="col-md-12 col-lg-4 mb-4 col-item">
                <div class="card">
                    <div class="card-body pt-5 pb-5 d-flex flex-lg-column flex-md-row flex-sm-row flex-column">
                        ${_discountBubble}
                        <div class="price-top-part text-center">
                            <!--<i class="iconsminds-male large-icon"></i>-->
                            ${_image}
                            <h5 class="mb-0 font-weight-semibold color-theme-1 mb-4">${businessPlan.Name}</h5>
                            ${compareAtPriceHTML}
                            <p class="text-large mb-2 text-default">Rs. ${businessPlan.Price}</p>
                            <p class="text-muted text-small">${businessPlan.BusinessPlanDurationTypeName}</p>
                        </div>
                        <div class="pl-3 pr-3 pt-3 pb-0 d-flex price-feature-list flex-column flex-grow-1">
                            <ul class="list-unstyled">
                                <li>
                                    <p class="mb-0 ">
                                        ${businessPlan.Description}
                                    </p>
                                </li>
                            </ul>
                            <div class="d-flex justify-content-around">
                                @if (permissionKeys.Contains("ManageBusinessPlans_ViewPackages_EditPackages"))
                                  {
                                    <button type="button" class="btn btn-md btn-outline-info" onclick="EditPackage(${businessPlan.Id})">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>

                                  }
                                @if (permissionKeys.Contains("ManageBusinessPlans_ViewPackages_DeletePackages"))
                                {
                                     <button type="button" class="btn btn-md btn-outline-danger" onclick="ConfirmDeletePackage(${businessPlan.Id},'${businessPlan.Name}')">
                                        <i class="fas fa-trash"></i> Delete
                                       </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
    `;
    return cardData;
}

function GetAllBusinessPlanDurationTypes() {
    var _url = "/api/BusinessPlanDurationType/GetAll";

    $.ajax({
        type: "GET",
        url: _url,
        headers: {
            "Authorization": "Bearer " + UserToken_Global,
            "Content-Type": "application/json"
        },
        contentType: 'application/json',
        success: function (response) {
            if (response.status < 1) {
                $.iaoAlert({
                    msg: '@(Resources.ErrorMessage.UnAuthorizedErrorMessage)',
                    type: "error",
                    mode: "dark",
                });
                return;
            }

            // --------------------- append parent categories in dropdown
            $("#ddlDurationType").html('');
            var res_DurationTypeList = '<option value="0">Select</option>';

            for (var i = 0; i < response.data.length; i++) {
                res_DurationTypeList += '<option value="' + response.data[i].Id + '">' + response.data[i].Value + '</option>';
            }

            $("#ddlDurationType").html('').append(res_DurationTypeList); //.select2();

            StopLoading();
        },
        error: function (result) {
            StopLoading();

            if (result["status"] == 401) {
                $.iaoAlert({
                    msg: '@(Resources.ErrorMessage.UnAuthorizedErrorMessage)',
                    type: "error",
                    mode: "dark",
                });
            }
            else {
                $.iaoAlert({
                    msg: '@(Resources.ErrorMessage.TechincalErrorMessage)',
                    type: "error",
                    mode: "dark",
                });
            }
        }
    });
}

    function btnSubmitFormClick() {
    let is_valid = true;
    $(".error-class").html('');

    let _planName = $("#txtPlanName").val().trim();
    let _durationTypeId = $("#ddlDurationType").val().trim();
    let _planType = $("#ddlplanType").val().trim();
    let _price = $("#txtPrice").val().trim();
    let _compareAtPrice = $("#txtCompareAtPrice").val().trim();
    //let _description = $("#txtDescription").val().trim();
    let _description = $("#txtDescription .ql-editor").html();

    let _error_planName = $("#error_txtPlanName");
    let _error_planType = $("#error_ddlplanType");
    let _error_durationTypeId = $("#error_ddlDurationType");
    let _error_price = $("#error_txtPrice");
    let _error_compareAtPrice = $("#error_txtCompareAtPrice");
    let _error_description = $("#error_txtDescription");

    var _isActivePlan = 0;
    if ($('#chkIsActive').is(':checked')) {
        // checked
        _isActivePlan = 1;
    }

    if (validate_IsEmptyStringInputFieldValue(_planName)) {
        is_valid = false;
        _error_planName.html('@(Resources.BusinessPanel.NameRequired)');
    }
    if (validate_IsEmptyStringInputFieldValue(_planType)) {
        is_valid = false;
        _error_planType.html('@(Resources.BusinessPanel.NameRequired)');
    }
    if (validate_IsEmptySelectInputFieldValue(_durationTypeId)) {
        is_valid = false;
        _error_durationTypeId.html('@(Resources.BusinessPanel.DurationTypeRequired)');
    }
    if (validate_IsEmptyStringInputFieldValue(_price) || isNaN(_price)) {
        is_valid = false;
        _error_price.html('@(Resources.BusinessPanel.PriceRequired)');
    }
    else if (parseFloat(_price) <= 0) {
        is_valid = false;
        _error_price.html('@(Resources.BusinessPanel.PriceValueRequired)');
    }
    if (_description == "") {
        is_valid = false;
        _error_description.html('@(Resources.BusinessPanel.DescriptionRequired)');
    }

    if (is_valid) {
        var _mode = (PlanId_Global > 0) ? 2 : 1;
        var encodedPlanDescription = encodeURIComponent(_description);

        var data = new FormData();
        data.append("Id", PlanId_Global);
        data.append("Name", _planName);
        data.append("BusinessPlanDurationTypeId", _durationTypeId);
        data.append("Description", encodedPlanDescription);
        data.append("PlanTypeTitle", _planType);
        data.append("Price", _price);
        data.append("CompareAtPrice", _compareAtPrice);
        data.append("Status", _isActivePlan);
        data.append("Mode", _mode);
        data.append("DiscountPercent", DiscountPercent_Global);

        var _planImageFile_MS = $("#filePlanImage_ManagePlan").get(0);
        var _planImageFiles = _planImageFile_MS.files;
        data.append('PlanImage', _planImageFiles[0]);

        $.ajax({
            url: '/api/BusinessPlan/AddUpdate',
            headers: {
                "Authorization": "Bearer " + UserToken_Global
            },
            data: data,
            processData: false,
            mimeType: 'multipart/form-data',
            contentType: false,
            //contentType: 'application/json',
            type: 'POST',
            success: function (dataResponse) {

                //--Parse into Json of response-json-string
                dataResponse = JSON.parse(dataResponse);

                //--If successfully added/updated
                if (dataResponse.status === 1) {
                    swal("Success!", dataResponse.message, "success");
                }
                else {
                    swal({
                        title: 'Error!',
                        icon: 'error',
                        text: dataResponse.message
                    });
                    StopLoading();
                    return;
                }

                ResetAddUpdateView();
                StopLoading();
                GetAllBusinessPlans();
            },
            error: function (result) {
                StopLoading();
                if (result["status"] == 401) {
                    $.iaoAlert({
                        msg: '@(Resources.ErrorMessage.UnAuthorizedErrorMessage)',
                        type: "error",
                        mode: "dark",
                    });
                }
                else {
                    $.iaoAlert({
                        msg: '@(Resources.ErrorMessage.TechincalErrorMessage)',
                        type: "error",
                        mode: "dark",
                    });
                }
            }
        });
    }

}

function showEditPackageView() {
    $('#sectionAddStaff').show();
    $('#sectionViewStaff').hide();
    document.getElementById("myText").innerHTML = "Edit Package";
    document.getElementById("ChangeUpdateText").innerHTML = "Update";
    document.getElementById("pageTextchange").innerHTML = "Edit Package";
    document.getElementById("pageStageChange").innerHTML = "Edit Package";
    $('#ChangeUpdateText').show();
    $('#btnAddPackage').hide();
    $(".error-class").html('');
};

    function EditPackage(id) {
    var _url = "/api/BusinessPlan/GetById/" + id;

    $.ajax({
        type: "GET",
        url: _url,
        headers: {
            "Authorization": "Bearer " + UserToken_Global,
            "Content-Type": "application/json"
        },
        contentType: 'application/json',
        success: function (response) {
            if (response.status < 1) {
                $.iaoAlert({
                    msg: response.message,
                    type: "error",
                    mode: "dark",
                });
                return;
            }
          

            $('.error-class').html('');

            $("#txtPlanName").val(response.data.Name);
            $("#ddlDurationType").val(response.data.BusinessPlanDurationTypeId);
            $("#ddlplanType").val(response.data.PlanType);
            $("#txtPrice").val(response.data.Price);
            $("#txtDescription .ql-editor").html(response.data.Description);
            $("#txtCompareAtPrice").val(response.data.CompareAtPrice);
            $("#txtDiscountPercent").val(response.data.DiscountPercent);

            //---Check Staff-Status
            if (response.data.Status == 1) {
                $('#chkIsActive').prop('checked', true);
            }
            else {
                $('#chkIsActive').prop('checked', false);
            }
            $("#filePlanImage_ManagePlan").val('');
            if (response.data.PlanImageWithPath != "") {
                $("#previewPlanImage").attr('src', response.data.PlanImageWithPath);
                $("#previewPlanImage").removeClass('d-none');
            }
            PlanId_Global = response.data.Id;

            showEditPackageView();

            StopLoading();
        },
        error: function (result) {
            StopLoading();

            if (result["status"] == 401) {
                $.iaoAlert({
                    msg: '@(Resources.ErrorMessage.UnAuthorizedErrorMessage)',
                    type: "error",
                    mode: "dark",
                });
            }
            else {
                $.iaoAlert({
                    msg: '@(Resources.ErrorMessage.TechincalErrorMessage)',
                    type: "error",
                    mode: "dark",
                });
            }
        }
    });
}

function ShowingViewStaffList() {

    $('#sectionViewStaff').show();

}

function ResetAddUpdateView() {
    $(".error-class").html('');
    $("#filePlanImage_ManagePlan").val('');
    $('#previewPlanImage').addClass('d-none');
    $("#previewPlanImage").attr('src', '');

    $("#txtPlanName").val('');
    $("#ddlDurationType").val(0);
    $("#txtPrice").val('');
    //$("#txtDescription").val('');
    $("#txtDescription .ql-editor").text('');
    $('#chkIsActive').prop('checked', true);
    $("#txtCompareAtPrice").val('');
    PlanId_Global = 0;
    $("#previewPlanImage").addClass('d-none');
    $("#txtDiscountPercent").val('');
    DiscountPercent_Global = 0;

    $('#sectionViewStaff').show();
    $('#sectionAddStaff').hide();
    $('#btnAddPackage').show();
    document.getElementById("pageTextchange").innerHTML = "Package";
    document.getElementById("pageStageChange").innerHTML = "Package";
    document.getElementById("ChangeUpdateText").innerHTML = "Save";

}


////// -----------    FIELD VALIDATION HANDLER FUNCTIONS  --------------------------

const validate_IsEmptyStringInputFieldValue = function (inputFieldValue) {
    if (inputFieldValue == '' || inputFieldValue.replace(/\s/g, "") == "")
        return true;
    return false;
}

const validate_IsEmptySelectInputFieldValue = function (inputFieldValue) {
    if (inputFieldValue == undefined || inputFieldValue == null || inputFieldValue == '' || inputFieldValue == 0)
        return true;
    return false;
}
////// -----------    FIELD VALIDATION HANDLER FUNCTIONS  --------------------------


// Image File Preview -------------------------------------------------------------
document.getElementById('filePlanImage_ManagePlan').addEventListener('change', handleImageUpload);

function handleImageUpload(event) {
    const file = event.target.files[0];
    const fileSize = file.size / 1024; // size in kilobytes
    const maxSize = 10 * 1024 * 1024; // maximum size in kilobytes
    const fileType = file.type;
    const validImageTypes = ['image/jpeg', 'image/png'];

    if (!validImageTypes.includes(fileType)) {
        $.iaoAlert({
            msg: '@(Resources.BusinessPanel.ValidImageTypesRequired)',
            type: "error",
            mode: "dark",
        });
        event.target.value = null; // clear the file input element
        $('#previewPlanImage').addClass('d-none'); // hide the preview image
        return;
    }
    if (fileSize > maxSize) {
        $.iaoAlert({
            msg: '@(String.Format(Resources.BusinessPanel.FileSizeRequired, "10 MB"))',
            type: "error",
            mode: "dark",
        });
        event.target.value = null; // clear the file input element
        $('#previewPlanImage').addClass('d-none'); // hide the preview image

        return;
    }

    // image size is within the limit, display the preview image
    const reader = new FileReader();
    reader.onload = function (event) {
        document.getElementById('previewPlanImage').src = event.target.result;
        $('#previewPlanImage').removeClass('d-none');
    }

    reader.readAsDataURL(file);
}
// Image File Preview -------------------------------------------------------------


function ConfirmDeletePackage(sid, packageName) {
    swal({
        title: "@(Resources.BusinessPanel.ConfirmDeletePackageTitle)",
        text: "@(Resources.BusinessPanel.ConfirmDeletePackageText) '"+packageName+"'?",
        type: "warning",
        buttons: {
            cancel: true,
            confirm: "@(Resources.ErrorMessage.Yes)",
        }
    })
    .then((willDelete) => {
        if (willDelete) {
            DeletePackage(sid);
        } else {
            //swal("Your imaginary file is safe!");
        }
    });
}

function DeletePackage(sid) {
    StartLoading();
    $.ajax({
        type: "POST",
        url: "/api/BusinessPlan/Delete/" + sid,
        headers: {
            "Authorization": "Bearer " + UserToken_Global,
            "Content-Type": "application/json"
        },
        contentType: 'application/json',
        success: function (dataResponse) {
            StopLoading();

            //--Check if staff successfully deleted
            if (dataResponse.status == 1) {
                setTimeout(function () {
                    swal("Success!", dataResponse.message, "success");
                    GetAllBusinessPlans();
                }, 100);
            }
            else {
                $.iaoAlert({
                    msg: dataResponse.message,
                    type: "error",
                    mode: "dark",
                });
            }
        },
        error: function (result) {
            StopLoading();

            if (result["status"] == 401) {
                $.iaoAlert({
                    msg: '@(Resources.ErrorMessage.UnAuthorizedErrorMessage)',
                    type: "error",
                    mode: "dark",
                });
            }
            else {
                $.iaoAlert({
                    msg:'@(Resources.ErrorMessage.TechincalErrorMessage)',
                    type: "error",
                    mode: "dark",
                });
            }
        }
    });
    }

    function CalculateDiscountPercentage() {
        const price = $("#txtPrice").val();
        const comparePrice = $("#txtCompareAtPrice").val();

        if (price == '' || comparePrice == '') {
            $("#txtDiscountPercent").val('');
        }
        else {
            const discount = ((comparePrice - price) / comparePrice) * 100;
            const discountPercentage = Math.round(discount);
            DiscountPercent_Global = discountPercentage;
            $("#txtDiscountPercent").val(discountPercentage);
        }

    }

</script>
