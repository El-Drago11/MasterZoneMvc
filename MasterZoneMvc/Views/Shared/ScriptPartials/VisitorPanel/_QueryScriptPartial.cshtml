<script>
    var UserToken_Global = "";
    var QueryId_Global = 0;
    var BusinessSearchLastRecordId_Global = 0;
    var QueryList_LastRecordId_Global = 0;
    var IsViewMoreQueryEnabled_Global = 0;
    var UpdateCardPaymentDetailId = 0;
    var MyAcademyUserLoginId_Global = 0;
     var OtherAcademyUserLoginId_Global = 0;
    $(document).ready(function () {
        StartLoading();
        $.get("/Home/GetStudentToken", null, function (dataToken) {
            if (dataToken != "" && dataToken != null) {
                UserToken_Global = dataToken;
                getAllBusinessOwnerLists();
            }
            else {
                $.iaoAlert({
                    msg: '@(Resources.ErrorMessage.UnAuthorizedErrorMessage)',
                    type: "error",
                    mode: "dark",
                });
                window.location.href = '/home/login';
                StopLoading();
            }
        });
    });

    $('#AddUpdateQueryModal').on('hide.bs.modal', function () {
        ResetAddUpdateQuery();
    });

function ResetAddUpdateQuery() {
    // Reset data
    $("#textqueries").val('');
    $("#textdescriptionqueries").val('');
    $("#ddlParentBusiness_Manage").val('0');
    $("input[type='radio']").prop('checked', false);
    $(".error-class").html('');
    QueryId_Global = 0;
    MyAcademyUserLoginId_Global = 0;
    OtherAcademyUserLoginId_Global = 0;
    $("#txtSearchBusiness").val('');
    // Query Modal setup to New-Query
    $('#AddUpdateQueryModal .modal-title').html('New Query');
    $('#submitQuery').html('Send');
    $("#AssignAcademyProfileSection").addClass('d-none');
    $("#AssignOtherBusinessProfileSection").addClass('d-none');
    //$('input[type="radio"][name="filter-item-type"]').prop('disabled', false);
    $('#academySelectorSection').removeClass('d-none');
    $("#BusinessOwnerDetail").html('');
}

 function btnAddUpdateQuery() {
        

    let is_valid = true;

    var _Mode = (QueryId_Global > 0) ? 2 : 1;
    //var _Mode = 1;
    $('.error-class').html('');

    let _query = $("#textqueries").val().trim();
    let _querydescription = $("#textdescriptionqueries").val().trim();
    //var _businessOwnerId = $("#ddlParentBusiness_Manage").val();

    let _error_query = $("#error_txtquery");
    let _error_querydescription = $("#error_txtdescriptions");
   // let _error_businessOnwerId = $("#error_ddlParentBusiness_Manage");

    if (validate_IsEmptyStringInputFieldValue(_query)) {
        is_valid = false;
        _error_query.html('@(Resources.VisitorPanel.TitleRequired)');
    }

    if (validate_IsEmptyStringInputFieldValue(_querydescription)) {
        is_valid = false;
        _error_querydescription.html('@(Resources.VisitorPanel.DescriptionRequired)');
    }

    @*if (validate_IsEmptySelectInputFieldValue(_businessOwnerId)) {
        is_valid = false;
        _error_businessOnwerId.html('@(Resources.VisitorPanel.SelectBussinessOwnerRequired)');
    }*@

    if (is_valid) {
        StartLoading();

        var data = new FormData();

        data.append("Id", QueryId_Global);
        data.append("Title", _query);
        data.append("Description", _querydescription);
        if (MyAcademyUserLoginId_Global > 0) {

          data.append("BusinessOwnerId", MyAcademyUserLoginId_Global);
        }
        else if (OtherAcademyUserLoginId_Global > 0) {

            data.append("BusinessOwnerId", OtherAcademyUserLoginId_Global);
        }
        data.append("Mode", _Mode);

        $.ajax({
            url: '/api/Query/AddUpdateQuery',
            headers: {
                "Authorization": "Bearer " + UserToken_Global
            },
            data: data,
            processData: false,
            mimeType: 'multipart/form-data',
            contentType: false,
            //contentType: 'application/json',
            type: 'POST',
            success: function (dataResponse) {

                //--Parse into Json of response-json-string
                dataResponse = JSON.parse(dataResponse);

                //--If successfully added/updated
                if (dataResponse.status === 1) {
                    swal("Success!", dataResponse.message, "success");
                    ResetAddUpdateQuery();
                    $('#btnCloseQueryModal').click();
                    ResetAllBusinessDetail();
                    getAllQueries();
                }
                else {
                    swal({
                        title: 'Error!',
                        icon: 'error',
                        text: dataResponse.message
                    });
                    StopLoading();

                    return;
                }

                StopLoading();
            },
            error: function (result) {
                StopLoading();

                if (result["status"] == 401) {
                    $.iaoAlert({
                        msg: '@(Resources.ErrorMessage.UnAuthorizedErrorMessage)',
                        type: "error",
                        mode: "dark",
                    });
                }
                else {
                    $.iaoAlert({
                        msg: '@(Resources.ErrorMessage.TechincalErrorMessage)',
                        type: "error",
                        mode: "dark",
                    });
                }
            }
        });
    }
}


function getAllQueries() {

    let _url = "/api/Query/GetAllByStudent?lastRecordId=0";

    $.ajax({
        type: "GET",
        url: _url,
        headers: {
            "Authorization": "Bearer " + UserToken_Global,
            "Content-Type": "application/json"
        },
        contentType: 'application/json',
        success: function (response) {
            if (response.status < 1) {
                $.iaoAlert({
                    msg: '@(Resources.ErrorMessage.UnAuthorizedErrorMessage)',
                    type: "error",
                    mode: "dark",
                });

                return;
            }

            var queryList = '';

            // if no queries found and not a hit from ViewMore.
            if (response.data.enqurylst.length <= 0) {
                $('#queryList').html('<div class="w-100 text-black-50 text-center mt-4"><i>You don\'t have any query!</i></div>');
                $('#btnViewMoreQuery').addClass('d-none');
                StopLoading();
                return;
            }

            if (response.data.enqurylst.length <= 0) {
                $('#btnViewMoreQuery').addClass('d-none');
            }
            else {
                QueryList_LastRecordId_Global = response.data.enqurylst[response.data.enqurylst.length - 1].Id;
                $('#btnViewMoreQuery').removeClass('d-none');
            }

            queryList = getHTMLBindedQueryData(response.data.enqurylst);

            $('#queryList').html(queryList);

            //getAllBusinessOwnerLists();

            StopLoading();
        },
        error: function (result) {
            StopLoading();
            //getAllBusinessOwnerLists();
            if (result["status"] == 401) {
                $.iaoAlert({
                    msg: '@(Resources.ErrorMessage.UnAuthorizedErrorMessage)',
                    type: "error",
                    mode: "dark",
                });
            }
            else {
                $.iaoAlert({
                    msg: '@(Resources.ErrorMessage.TechincalErrorMessage)',
                    type: "error",
                    mode: "dark",
                });
            }
        }
    });
}

function ViewMoreQueries() {

    let _url = "/api/Query/GetAllByStudent?lastRecordId=" + QueryList_LastRecordId_Global;

    $.ajax({
        type: "GET",
        url: _url,
        headers: {
            "Authorization": "Bearer " + UserToken_Global,
            "Content-Type": "application/json"
        },
        contentType: 'application/json',
        success: function (response) {
            if (response.status < 1) {
                $.iaoAlert({
                    msg: '@(Resources.ErrorMessage.UnAuthorizedErrorMessage)',
                    type: "error",
                    mode: "dark",
                });

                return;
            }

            var queryList = '';

            if (response.data.enqurylst.length <= 0) {
                $('#btnViewMoreQuery').addClass('d-none');
            }
            else {
                QueryList_LastRecordId_Global = response.data.enqurylst[response.data.enqurylst.length - 1].Id;
                $('#btnViewMoreQuery').removeClass('d-none');
            }

            queryList = getHTMLBindedQueryData(response.data.enqurylst);

            $('#queryList').append(queryList);

            //getAllBusinessOwnerLists();

            StopLoading();
        },
        error: function (result) {
            StopLoading();
            //getAllBusinessOwnerLists();
            if (result["status"] == 401) {
                $.iaoAlert({
                    msg: '@(Resources.ErrorMessage.UnAuthorizedErrorMessage)',
                    type: "error",
                    mode: "dark",
                });
            }
            else {
                $.iaoAlert({
                    msg: '@(Resources.ErrorMessage.TechincalErrorMessage)',
                    type: "error",
                    mode: "dark",
                });
            }
        }
    });
}

function getHTMLBindedQueryData(queryList) {
    var htmlData = '';

    for (var i = 0; i < queryList.length; i++) {

        var deleteIconButton = '<i class="fas fa-trash" style="cursor:pointer;margin-left:14px;" onclick="confrimDelete_ManageQuery(' + queryList[i].Id + ')" title="Delete Query"></i>';

        var editOrViewAction = '';
        if (queryList[i].IsReplied == 0) {
            editOrViewAction = '<i class="fas fa-edit" style="cursor:pointer" data-toggle="modal" data-target="#myQueryModal" onclick="EditQuery(' + queryList[i].Id + ')" title="Edit Query"></i>';
        }
        else {
            editOrViewAction = '<i class="fas fa-eye" style="cursor:pointer" onclick="getQueryDetailById(' + queryList[i].Id + ')" title="View Query"></i>';
        }
        var query = queryList[i];
        //${ moment(query.CreatedOn).format('YYYY-MM-DD') }
        var queryBusinessNamePhrase = (query.BusinessName == "") ? "" : " - " + query.BusinessName;
        htmlData += `
                    <div class="enq-cnt-liuijl enq-cnt-liuijl">
                        <div>
                            <div class="enq-cnt-inner border-bottom d-flex justify-content-between">
                                <a href="javascript:getQueryDetailById(${query.Id});" class="enq-cnt-link-kddd flex-grow-1">
                                    <h6 class="enq-h-urie" >${query.Title} ${queryBusinessNamePhrase}</h6>
                                    <p class="enq-txt-rjei">${query.CreatedOn_FormatDate}</p>
                                </a>
                                <div>
                                    ${editOrViewAction} ${deleteIconButton}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
    }

    return htmlData;
}

function getQueryDetailById(id) {
    StartLoading();
    let _url = "/api/Query/GetById?id=" + id;

    $.ajax({
        type: "GET",
        url: _url,
        headers: {
            "Authorization": "Bearer " + UserToken_Global,
            "Content-Type": "application/json"
        },
        contentType: 'application/json',
        success: function (response) {
            if (response.status < 1) {
                $.iaoAlert({
                    msg: '@(Resources.ErrorMessage.UnAuthorizedErrorMessage)',
                    type: "error",
                    mode: "dark",
                });

                return;
            }

            if (response.data && response.data != null) {
                var modalBody = `<p class="modl-txt">${response.data.Description}</p>`;
                if (response.data.IsReplied == 1) {
                    modalBody += `<hr/><h6 class="text-black-50"><i class="fa fa-reply"></i> Reply <span class="float-right">${response.data.RepliedOn_FormatDate}</span></h6>
                            <p class="modl-txt">${response.data.ReplyBody}</p>
                        `;
                }
                $('#enq-modal1a .modal-title').html(response.data.Title);
                $('#enq-modal1a .modal-body').html(modalBody);
                $('#enq-modal1a').modal('show');
            }
            else {
                $.iaoAlert({
                    msg: '@(Resources.VisitorPanel.QueryDoesNotGetData_ErrorMessage)',
                    type: "error",
                    mode: "dark",
                });
            }

            StopLoading();
        },
        error: function (result) {

            if (result["status"] == 401) {
                $.iaoAlert({
                    msg: '@(Resources.ErrorMessage.UnAuthorizedErrorMessage)',
                    type: "error",
                    mode: "dark",
                });
            }
            else {
                $.iaoAlert({
                    msg: '@(Resources.ErrorMessage.TechincalErrorMessage)',
                    type: "error",
                    mode: "dark",
                });
            }
        }
    });
}

function confrimDelete_ManageQuery(id) {
    swal({
        title: "@(Resources.VisitorPanel.ConfirmDeleteQueryTitle)",
        text: "@(Resources.VisitorPanel.ConfirmDeleteQueryText)",
        type: "warning",
        buttons: {
            cancel: true,
            confirm: "@(Resources.ErrorMessage.Yes)",
        }
    })
    .then((willDelete) => {
        if (willDelete) {
            DeleteQuery(id);
        } else {
            //swal("Your imaginary file is safe!");
        }
    });
}

function DeleteQuery(id) {
    StartLoading();
    $.ajax({
        type: "POST",
        url: "/api/Query/Delete?id=" + id,
        headers: {
            "Authorization": "Bearer " + UserToken_Global,
            "Content-Type": "application/json"
        },
        contentType: 'application/json',
        success: function (dataResponse) {
            StopLoading();

            //--Check if staff successfully deleted
            if (dataResponse.status == 1) {
                setTimeout(function () {
                    swal("Success!", dataResponse.message, "success");
                }, 100);
                getAllQueries();
            }
            else {
                $.iaoAlert({
                    msg: dataResponse.message,
                    type: "error",
                    mode: "dark",
                });
            }

        },
        error: function (result) {
            StopLoading();

            if (result["status"] == 401) {
                $.iaoAlert({
                    msg: '@(Resources.ErrorMessage.UnAuthorizedErrorMessage)',
                    type: "error",
                    mode: "dark",
                });
            }
            else {
                $.iaoAlert({
                    msg: '@(Resources.ErrorMessage.TechincalErrorMessage)',
                    type: "error",
                    mode: "dark",
                });
            }
        }
    });
}

function EditQuery(id) {
    var _url = "/api/Query/GetById/?id=" + id;

    StartLoading();

    $.ajax({
        type: "GET",
        url: _url,
        headers: {
            "Authorization": "Bearer " + UserToken_Global,
            "Content-Type": "application/json"
        },
        contentType: 'application/json',
        success: function (response) {
            if (response.status < 1) {
                $.iaoAlert({
                    msg: response.message,
                    type: "error",
                    mode: "dark",
                });
                return;
            }
            ResetAddUpdateQuery();

            // Edit Modal setup
            $('#AddUpdateQueryModal .modal-title').html('Edit Query');
            $('#submitQuery').html('Update');

            QueryId_Global = response.data.Id;

            $("#textqueries").val(response.data.Title);
            $("#ddlParentBusiness_Manage").val(response.data.BusinessOwnerId);
            $("#textdescriptionqueries").val(response.data.Description);

            var businessCard = `
                <div class="row">
                 <div class="col-6 mb-2">
                     <div class="align-items-center border d-flex flex-row p-2 w-100">
                         <img class="business-logo" src="${response.data.BusinessLogoWithPath}">
                         <div class="d-flex flex-column flex-grow-1 mx-3">
                             <div class="text-bold"><a target="_blank" href="/Home/BusinessProfile?businessOwnerLoginId=${response.data.BusinessOwnerLoginId}">${response.data.BusinessName}</a></div>
                             <div class="text-muted"> ${response.data.BusinessSubCategoryName}</div>
                         </div>
                     </div>
                 </div>
                 </div>
            `;

            $("#BusinessOwnerDetail").html(businessCard);

            //$('input[type="radio"][name="filter-item-type"]').prop('disabled', true);
            $('#academySelectorSection').addClass('d-none');
            $('#btnAddUpdateQueryModal').click();
            StopLoading();
        },
        error: function (result) {
            StopLoading();

            if (result["status"] == 401) {
                $.iaoAlert({
                    msg: '@(Resources.ErrorMessage.UnAuthorizedErrorMessage)',
                    type: "error",
                    mode: "dark",
                });
            }
            else {
                $.iaoAlert({
                    msg: '@(Resources.ErrorMessage.TechincalErrorMessage)',
                    type: "error",
                    mode: "dark",
                });
            }
        }
    });
}

function AddQuery() {
    $('#btnAddUpdateQueryModal').click();
    ResetAllBusinessDetail();
    }


    function getAllBusinessOwnerLists() {
    let _url = "/api/Student/GetBusinessOnwers";

    $.ajax({
        type: "GET",
        url: _url,
        headers: {
            "Authorization": "Bearer " + UserToken_Global,
            "Content-Type": "application/json"
        },
        contentType: 'application/json',
        success: function (response) {
            if (response.status < 1) {
                $.iaoAlert({
                    msg: '@(Resources.ErrorMessage.UnAuthorizedErrorMessage)',
                    type: "error",
                    mode: "dark",
                });
                return;
            }

            var businessOwnersHTML = ""; // Variable to store HTML for all business owners

            // Loop through each business owner in the response data
            for (var i = 0; i < response.data.length; i++) {
                var businessOwner = response.data[i];

                var uniqueCheckboxId = 'checkbox_' + businessOwner.Id;

                var _businessName = (businessOwner.BusinessName == null || businessOwner.BusinessName == "") ? "--" : businessOwner.BusinessName;

                // Build HTML for each business owner and append it to the businessOwnersHTML variable
                businessOwnersHTML += `
                    <div class="col-6 mb-2">
                        <div class="align-items-center border d-flex flex-row p-2 w-100">
                            <img class="business-logo" src="${businessOwner.BusinessLogoWithPath}">
                            <div class="d-flex flex-column flex-grow-1 mx-3">
                                <div class="text-bold"><a target="_blank" href="/Home/BusinessProfile?businessOwnerLoginId=${businessOwner.UserLoginId}">${_businessName}</a></div>

                                <div class="text-muted"> ${businessOwner.BusinessMasterId}</div>
                                <div class="text-muted">${businessOwner.BusinessSubCategoryName}</div>
                            </div>
                            <div class="">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="businessOwnerId" id="${uniqueCheckboxId}" value="${businessOwner.Id}" onclick="BusinessCheckedUserId(${businessOwner.Id})">


                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Append all business owners HTML to the appropriate container
            $("#searchedBusinessOwners").html(businessOwnersHTML);

            // Call additional function or perform other actions after rendering business owners
            getAllQueries();
            StopLoading();
        },
        error: function (result) {
            StopLoading();

            if (result["status"] == 401) {
                $.iaoAlert({
                    msg: '@(Resources.ErrorMessage.UnAuthorizedErrorMessage)',
                    type: "error",
                    mode: "dark",
                });
            } else {
                $.iaoAlert({
                    msg: '@(Resources.ErrorMessage.TechincalErrorMessage)',
                    type: "error",
                    mode: "dark",
                });
            }
        }
    });
}

    function BusinessCheckedUserId(userLoginId) {
        MyAcademyUserLoginId_Global = userLoginId;
    }




///// -----------    FIELD VALIDATION HANDLER FUNCTIONS  --------------------------
function validate_IsEmptyStringInputFieldValue(inputFieldValue) {
    if (inputFieldValue == '' || inputFieldValue.replace(/\s/g, "") == "")
        return true;
    return false;
}

function validate_IsEmptySelectInputFieldValue(inputFieldValue) {
    if (inputFieldValue == undefined || inputFieldValue == null || inputFieldValue == '' || inputFieldValue == 0)
        return true;
    return false;
}
///// -----------    FIELD VALIDATION HANDLER FUNCTIONS  --------------------------

    function resetAssignQuerySection() {
        $('#txtSearchBusiness').val('');
        $('#searchedBusinessOwnersList').html('');
        $('#btnSearchBusinessShowMore').addClass('d-none');
        $(".myacademies").addClass('d-none');
    }


    function AllBusinessOwnerSearch() {
        $("#AssignOtherBusinessProfileSection").removeClass('d-none');
        $("#AssignAcademyProfileSection").addClass('d-none');
        $("#txtSearchBusiness").val('');
        $("#textqueries").val('');
        $("#textdescriptionqueries").val('');
    }
    function OtherBusinessOwnerSearch() {
        $("#AssignAcademyProfileSection").removeClass('d-none');
        $("#AssignOtherBusinessProfileSection").addClass('d-none');
        $("#textqueries").val('');
        $("#textdescriptionqueries").val('');
        $(".myacademies").addClass('d-none');
    }

     function getBusinessOnwersBySearch(isRefresh = true) {
         let _url = "/api/Business/GetAllBySearchForSuperAdmin";
        let _searchKeyword = $('#txtSearchBusiness').val().trim();

        if (isRefresh) {
            BusinessSearchLastRecordId_Global = 0;
            $("#searchedBusinessOwnersList").html('');
        }
         var recordLimit = 10;
        let requestData = {
            SearchKeyword: _searchKeyword,
            LastRecordId: BusinessSearchLastRecordId_Global
        };

        $.ajax({
            type: "POST",
            url: _url,
            data: JSON.stringify(requestData),
            headers: {
                "Authorization": "Bearer " + UserToken_Global,
                "Content-Type": "application/json"
            },
            contentType: 'application/json',
            success: function (response) {
                if (response.status < 1) {
                    $.iaoAlert({
                        msg: response.message,
                        type: "error",
                        mode: "dark",
                    });
                    return;
                }

                var bindedSearchResultHTML = '';

                for (var i = 0; i < response.data.length; i++) {
                    bindedSearchResultHTML += getbindedAssignBusinessCards(response.data[i]);
                }

                if (response.data.length <= 0) {
                    bindedSearchResultHTML = '<div class="w-100 text-center text-muted"><i>@(Resources.ErrorMessage.NotFound)</i></div>';
                }

                if (response.data.length == recordLimit) {
                    BusinessSearchLastRecordId_Global = response.data[response.data.length - 1].Id;
                    // display show more button
                    $('#btnSearchBusinessShowMore').removeClass('d-none');
                }
                else {
                    $('#btnSearchBusinessShowMore').addClass('d-none');
                }


                $("#searchedBusinessOwnersList").append(bindedSearchResultHTML);
            },
            error: function (result) {

                if (result["status"] == 401) {
                    $.iaoAlert({
                        msg: '@(Resources.ErrorMessage.UnAuthorizedErrorMessage)',
                        type: "error",
                        mode: "dark",
                    });
                }
                else {
                    $.iaoAlert({
                        msg: '@(Resources.ErrorMessage.TechincalErrorMessage)',
                        type: "error",
                        mode: "dark",
                    });
                }
            }
        });
    }

    function getbindedAssignBusinessCards(businessVM) {
        $(".myacademies").removeClass('d-none');
        var _assignActionBtn = '';
        var uniqueotherCheckboxId = 'checkbox_' + businessVM.Id;

        _assignActionBtn += `
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="businessRadio" id="${uniqueotherCheckboxId}" value="${businessVM.Id}" onclick="allbusinessuserId(${businessVM.Id})">
                </div> `;

        var _businessName = (businessVM.BusinessName == null || businessVM.BusinessName == "") ? "--" : businessVM.BusinessName;
        return `
            <div class="col-6 mb-2">
                <div class="align-items-center border d-flex flex-row p-2 w-100">
                    <img class="business-logo" src="${businessVM.BusinessLogoWithPath}">
                    <div class="d-flex flex-column flex-grow-1 mx-3">
                        <div class="text-bold"><a target="_blank" href="/Home/BusinessProfile?businessOwnerLoginId=${businessVM.UserLoginId}">${_businessName}</a></div>
                        <div class="text-muted"> ${businessVM.BusinessMasterId}</div>
                        <div class="text-muted"> ${businessVM.BusinessSubCategoryName}</div>
                    </div>
                    <div class="">
                        ${_assignActionBtn}
                    </div>
                </div>
            </div>
        `;
    }

    function allbusinessuserId(businessuserLoginId) {

    OtherAcademyUserLoginId_Global = businessuserLoginId;
    }


    function ResetAllBusinessDetail() {
        // Reset radio button selection
        $("input[type='radio']").prop('checked', false);

    }


</script>
