
<script>
    var UserToken_Global = "";
    var _groupid_globally = "";

  var GroupId = $('#hiddenGroupId').val();
    $(document).ready(function () {
        StartLoading();
        $.get("/Home/GetStudentToken", null, function (dataToken) {
            if (dataToken != "" && dataToken != null) {
                UserToken_Global = dataToken;
                btnsubmitmessagegrouphtml();
                GetGroupMessageDetailById(GroupId);
                setInterval(() => GetGroupMessageDetailById(GroupId), 2000)
                GetGroupList();
                StopLoading();
            }
            else {
                $.iaoAlert({
                    msg: '@(Resources.ErrorMessage.UnAuthorizedErrorMessage)',
                    type: "error",
                    mode: "dark",
                });
                window.location.href = '/home/login';
                StopLoading();
            }
        });
    });


    function btnsubmitmessagegrouphtml() {
        var html1 = ``;
        html1 = `<button type="button" class="btn btn-primary icon-button large" onclick="btnSubmitGroupMessage();">
            <i class="fa fa-chevron-right"></i>
        </button>`;

        $('#divforbtn').html(html1);
    }
    function ResetBtn() {
        $('#MessageBodyText').val('');
    }

    function btnSubmitGroupMessage() {
        ;
        var _groupid = ``;
        if (_groupid_globally == null) {
             _groupid = GroupId;
        } else {
             _groupid = _groupid_globally;
        }

    let is_valid = true;
    $(".error-class").html('');
    var _mode = 3;

    let _Messagebodytext = $("#MessageBodyText").val().trim();

    //let _error_Messagebodytext = $("#error_MessageBodyText");


    if (validate_IsEmptyStringInputFieldValue(_Messagebodytext)) {
            is_valid = false;
        //_error_Messagebodytext.html('@(Resources.BusinessPanel.MessageTextRequired)');

        }


     if (is_valid) {
         var data = new FormData();

         data.append("Messagebody", _Messagebodytext);
         data.append('Mode', _mode);

        $.ajax({
            url: '/api/Message/AddUpdateGroupMessge?toUserLoginId=' + _groupid,
            headers: {
                "Authorization": "Bearer " + UserToken_Global,

            },
            data: data,
            processData: false,
            mimeType: 'multipart/form-data',
            contentType: false,
            //contentType: 'application/json',
            type: 'POST',
            success: function (dataResponse) {

                //--Parse into Json of response-json-string
                dataResponse = JSON.parse(dataResponse);

                //--If successfully added/updated
                if (dataResponse.status === 1) {
                    $.iaoAlert({
                        msg: dataResponse.message,
                        type: "success",
                        mode: "dark",
                    });
                    $('#MessageBodyText').val('');

                    GetGroupMessageDetailById(_groupid);
                }
                else {
                    swal({
                        title: 'Error!',
                        icon: 'error',
                        text: dataResponse.message
                    });
                    StopLoading();
                    ResetBtn();
                    return;
                }


                StopLoading();

            },
            error: function (result) {
                StopLoading();


                if (result["status"] == 401) {
                    $.iaoAlert({
                        msg: '@(Resources.ErrorMessage.UnAuthorizedErrorMessage)',
                        type: "error",
                        mode: "dark",
                    });
                }
                else {
                    $.iaoAlert({
                        msg: '@(Resources.ErrorMessage.TechincalErrorMessage)',
                        type: "error",
                        mode: "dark",
                    });
                }
            }
        });
    }

}

    function GetGroupMessageDetailById(groupid, _groupProfileImageWithPath, _businessName, _groupname, _batchStartTime, _batchEndTime) {

        $('#btnAddMessage').val('');
        var _url = "/api/Message/GetGroupDetailsById?id=" + groupid;

    $.ajax({
        type: "GET",
        url: _url,
        headers: {
            "Authorization": "Bearer " + UserToken_Global,
            "Content-Type": "application/json"
        },
        contentType: 'application/json',
        success: function (response) {
            if (response.status < 1) {
                $.iaoAlert({
                    msg: response.message,
                    type: "error",
                    mode: "dark",
                });
                return;
            }

            var htmlData1 = '';
            var htmlData3 = '';
            if (_groupProfileImageWithPath != null && _businessName != null) {
                htmlData3 += `
                                            <div class="col-8">
                         <div class="gruop-msg-iner">
                             <h2 class="mk-hdffjsdkfj-enq">Group Message</h2>
                             <p class="time-gruop">${_groupname} ${_batchStartTime} to ${_batchEndTime}</p>
                             <p class="student-in">Student ${response.data.CountStudentGroup.CountStudent}/${response.data.RecevierUserLoginDetail.TotalCountSeat}</p>
                         </div>
                     </div>
                     <div class="col-4 text-right"><div class="col-md-12">
                        <div class="d-flex flex-row justify-content-end mb-3">
                            <div class="d-flex flex-row">
                                <img alt="Profile Picture" src="${_groupProfileImageWithPath}"
                                     class="img-thumbnail border-0 rounded-circle ml-0 mr-4 list-thumbnail align-self-center small" style=">
                                <div class=" d-flex min-width-zero">
                                    <div class=" pl-0 align-self-center d-flex flex-column flex-lg-row justify-content-between min-width-zero">
                                        <div class="min-width-zero">
                                            <p class="list-item-heading mb-1 truncate ">${_businessName} </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>`;
            }
            else

            {
                htmlData3 += `
                    <div class="col-8">
                     <div class="gruop-msg-iner">
                         <h2 class="mk-hdffjsdkfj-enq">Group Message</h2>
                         <p class="time-gruop">${response.data.RecevierUserLoginDetail.GroupName} 5 to 6 pm </p>
                         <p class="student-in">Student ${response.data.CountStudentGroup.CountStudent}/${response.data.RecevierUserLoginDetail.TotalCountSeat}</p>
                     </div>
                 </div>
                 <div class="col-4 text-right"><div class="col-md-12">
                    <div class="d-flex flex-row justify-content-end mb-3">
                        <div class="d-flex flex-row">
                            <img alt="Profile Picture" src="${response.data.RecevierUserLoginDetail.GroupProfileImageWithPath}"
                                 class="img-thumbnail border-0 rounded-circle ml-0 mr-4 list-thumbnail align-self-center small" style=">
                            <div class=" d-flex min-width-zero">
                                <div class=" pl-0 align-self-center d-flex flex-column flex-lg-row justify-content-between min-width-zero">
                                    <div class="min-width-zero">
                                        <p class="list-item-heading mb-1 truncate ">${response.data.RecevierUserLoginDetail.BusinessName}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>`;
            }

            $('#MainStudentUser').html(htmlData3);
            _groupid_globally = response.data.RecevierUserLoginDetail.Id;
            for (var i = 0; i < response.data.MessageList.length; i++) {

                //var UserInfo1 = response.data.RecevierUserLoginDetail;
                var UserInfo = response.data.RecevierUserLoginDetail;
                if (response.data.MessageList[i].CreatedByLoginId == response.data.MessageList[i].SenderUserloginId) {
                    htmlData1 += `
                            <div class="card  col-md-9 d-inline-block mb-3 mr-2" style="float: left;">
                                <div class=" pt-1 pr-2 r-0" style="float: right">
                                    <span class="text-extra-small text-muted">${response.data.MessageList[i].CreatedOn_FormatDate}    ${response.data.MessageList[i].Time}</span>
                                </div>
                                <div class="card-body p-0 pb-2">
                                    <div class="d-flex flex-row pt-2">
                                        <a class="d-flex" href="#">
                                           <img alt="Profile Picture" src="${response.data.MessageList[i].ProfileImageWithPath}" class="img-thumbnail border-0 rounded-circle mr-3 list-thumbnail align-self-center xsmall profile-img">
                                         </a>
                                        <div class="d-flex flex-grow-1 min-width-zero">
                                            <div class="m-2 pl-0 align-self-center d-flex flex-column flex-lg-row justify-content-between min-width-zero">
                                                <div class="min-width-zero">
                                                    <p class="mb-0"> ${response.data.MessageList[i].Messagebody}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                }
                else
                {
                   // var UserInfo1 = response.data.SenderUserLoginDetail;
                    htmlData1 += `<div class="card  col-md-9 d-inline-block mb-3 mr-2" style="float: right;">
                                <div class="pt-1 pr-2 r-0" style="float: right">
                                    <span class="text-extra-small text-muted">${response.data.MessageList[i].CreatedOn_FormatDate}   ${response.data.MessageList[i].Time}</span>
                                </div>
                                <div class="card-body p-0 pb-2">
                                    <div class="d-flex flex-row pb-2">

                                        <div class=" d-flex flex-grow-1 min-width-zero">
                                            <div class="m-2 pl-0 align-self-center d-flex flex-column flex-lg-row justify-content-between min-width-zero">
                                                <div class="min-width-zero">
                                                    <p class="mb-0 truncate list-item-heading"></p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="chat-text-left">
                                        <p class="mb-0 text-semi-muted">
                                            ${response.data.MessageList[i].Messagebody}
                                        </p>
                                    </div>
                                </div>

                            </div>`;

               }

            }

            if (response.data.MessageList.length <= 0) {
                htmlData1 = `<div class="w-100 text-center font-italic"><span class="w-auto py-2 px-5 bg-primary text-white rounded">@(Resources.VisitorPanel.Message_StartANewConversation)</span></div>`;
            }

            $('#MessageView').html(htmlData1);
            $("#MessageView").animate({
                scrollTop: $('#MessageView').get(0).scrollHeight
            }, 100);
            btnMarkAsReadOrUnread(groupid);

        },
        error: function(result) {
            StopLoading();

            if (result["status"] == 401) {
                $.iaoAlert({
                    msg: '@(Resources.ErrorMessage.UnAuthorizedErrorMessage)',
                    type: "error",
                    mode: "dark",
                });
            }
            else {
                $.iaoAlert({
                    msg: '@(Resources.ErrorMessage.TechincalErrorMessage)',
                    type: "error",
                    mode: "dark",
                });
            }
        }
    });
    }
 
    function GetGroupList() {

     var searchbyname = $("#searchvaluegroupnme").val();
   
      var _url = "/api/Message/GetAllGroupList?searchname=" + searchbyname;

    


  $.ajax({
     type: "GET",
     url: _url,
     headers: {
         "Authorization": "Bearer " + UserToken_Global,
         "Content-Type": "application/json"
     },
     contentType: 'application/json',
     success: function (response) {
         if (response.status < 1) {
             $.iaoAlert({
                 msg: response.message,
                 type: "error",
                 mode: "dark",
             });
             return;
         }
         var htmlData = '';

         $('#sidebarGroupListForChat').empty();

         var resp = response.data.GroupDetail == undefined ? response.data.GroupDetails : response.data.GroupDetail;


         for (var i = 0; i < resp.length; i++) {
             var newMessageCount = resp[i].NewMessageCount;

             if (newMessageCount == 0) {
                 var element = "";

             }
             else {
                 var element = `
                  <span class="CountMessage">${newMessageCount}</span>
                       `;
             }

             htmlData += `<a href="/Home/GroupMessageChat?toUserLoginId=${encodeURIComponent(resp[i].EncryptedUserLoginId)}"><div class="gruop-msg-item">
                    <div class="gruop-msg-img">
                        <img src="${resp[i].GroupProfileImageWithPath}" loading="lazy" height="50" width="50" alt="img">
                    </div>
                    <div class="gruop-msg-text">
                        <h6>${resp[i].GroupName}  ${resp[i].batchStartTime} to ${resp[i].batchEndTime}</h6>
                        <h6 class="img-flex">
                            <span> <img class="verify-img" src="/Content/visitor-panel/image/security.png" loading="lazy" alt="verify"></span>
                            ${resp[i].BusinessName}
                        </h6>
                    </div>
                </div></a>`;
         }

         if (resp.length <= 0) {
             htmlData = `<div class="w-100 text-center font-italic">@(Resources.VisitorPanel.Message_NoBusinessOwnersToChat)</div>`;
         }

         $('#sidebarGroupListForChat').append(htmlData);

     },

     error: function(result) {
         StopLoading();

         if (result["status"] == 401) {
             $.iaoAlert({
                 msg: '@(Resources.ErrorMessage.UnAuthorizedErrorMessage)',
                 type: "error",
                 mode: "dark",
             });
         }
         else {
             $.iaoAlert({
                 msg: '@(Resources.ErrorMessage.TechincalErrorMessage)',
                 type: "error",
                 mode: "dark",
             });
         }
     }
 });
 }

    ////// -----------    FIELD VALIDATION HANDLER FUNCTIONS  --------------------------

    const validate_IsEmptyStringInputFieldValue = function (inputFieldValue) {
        if (inputFieldValue == '' || inputFieldValue.replace(/\s/g, "") == "")
            return true;
        return false;
    }
    ////// -----------    FIELD VALIDATION HANDLER FUNCTIONS  --------------------------


    ///Read  status
    function btnMarkAsReadOrUnread(id) {

        var _Params = {
            "Id": id,
            "SenderStatus": 1,
        };

        $.ajax({
            url: '/api/Message/MarkAsReadUnread',
            data: JSON.stringify(_Params),
            processData: false,
            headers: {
                "Authorization": "Bearer " + UserToken_Global,
                "Content-Type": "application/json"
            },
            contentType: 'application/json',
            type: 'POST',
            success: function (dataResponse) {
                //--If successfully added/updated
                if (dataResponse.status === 1) {

                }
                else {
                    swal({
                        title: '',
                        imageUrl: '/Content/svg/error.svg',
                        text: dataResponse.message
                    });

                }
            },
            error: function (result) {
                if (result["status"] == 401) {
                    $.iaoAlert({
                        msg: '@(Resources.ErrorMessage.UnAuthorizedErrorMessage)',
                        type: "error",
                        mode: "dark",
                    });
                }
                else {
                    $.iaoAlert({
                        msg: '@(Resources.ErrorMessage.TechincalErrorMessage)',
                        type: "error",
                        mode: "dark",
                    });
                }
            }
        });
    }


</script>

